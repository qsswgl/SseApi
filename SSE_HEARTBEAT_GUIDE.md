# SSE 心跳包功能测试指南

## 🚀 快速开始

### 1. 启动服务器
```bash
cd K:\SseApi_NET10
dotnet run --project SseApi.csproj
```

服务器将在 http://localhost:5103 启动

### 2. 访问测试页面
在浏览器中打开：http://localhost:5103

## 🎯 主要功能

### ✅ 已实现的SSE心跳包功能

1. **SSE连接管理**
   - 自动生成客户端ID
   - 连接状态实时监控
   - 连接时长统计

2. **心跳包机制**
   - 每30秒自动发送心跳包
   - 心跳超时检测（45秒）
   - 可视化心跳状态指示器

3. **自动重连机制**
   - 连接断开时自动重连
   - 指数退避重连策略
   - 最大重连次数限制（5次）

4. **消息广播**
   - 支持向所有连接的客户端广播消息
   - 支持向特定客户端发送消息
   - 实时消息统计

5. **连接监控**
   - 实时显示活跃连接数
   - 连接列表查看
   - 详细的连接统计信息

## 🔧 API端点

| 端点 | 方法 | 描述 |
|------|------|------|
| `/sse` | GET | SSE连接端点 |
| `/sse/status` | GET | 获取服务器连接状态 |
| `/sse/broadcast` | POST | 广播消息到所有客户端 |
| `/sse/send/{clientId}` | POST | 发送消息到特定客户端 |
| `/` | GET | 重定向到测试页面 |

## 📊 测试页面功能

### 连接控制
- 连接/断开SSE
- 实时连接状态显示
- 连接时长计时器

### 心跳包监控
- 心跳包接收指示器
- 心跳包计数统计
- 心跳超时警告

### 消息测试
- 发送广播消息
- 查看服务器状态
- 实时日志显示

### 统计信息
- 收到消息总数
- 心跳包数量
- 重连次数
- 错误次数

## 🧪 测试场景

### 1. 基本连接测试
1. 点击"连接 SSE"按钮
2. 观察连接状态变为"已连接"
3. 观察客户端ID的生成
4. 等待心跳包的接收

### 2. 心跳包测试
1. 建立连接后等待30秒
2. 观察心跳包指示器的闪烁
3. 检查心跳包计数的增加
4. 验证"最后心跳"时间的更新

### 3. 重连机制测试
1. 建立连接
2. 手动断开服务器（Ctrl+C）
3. 观察自动重连尝试
4. 重启服务器，验证重连成功

### 4. 消息广播测试
1. 建立连接
2. 在输入框中输入消息
3. 点击"广播消息"
4. 观察消息在日志中的显示

### 5. 多客户端测试
1. 在多个浏览器标签页中打开测试页面
2. 在不同标签页中建立连接
3. 点击"服务器状态"查看活跃连接数
4. 在一个标签页中发送广播消息
5. 验证所有标签页都能收到消息

## 🔍 日志监控

测试页面提供了详细的日志功能：
- 📘 信息日志（蓝色）：一般信息
- 📗 成功日志（绿色）：成功操作
- 📙 警告日志（黄色）：警告信息
- 📕 错误日志（红色）：错误信息
- 💖 心跳日志（粉色）：心跳包相关

## ⚙️ 配置参数

在`Program.cs`中可以调整以下参数：

```csharp
// 心跳包间隔（默认30秒）
private readonly TimeSpan _heartbeatInterval = TimeSpan.FromSeconds(30);

// 心跳超时时间（前端默认45秒）
heartbeatTimeout = setTimeout(() => {
    // 超时处理
}, 45000);

// 最大重连次数（前端默认5次）
let maxReconnectAttempts = 5;
```

## 🎨 技术特性

### 后端技术
- .NET 10.0 ASP.NET Core
- Server-Sent Events (SSE)
- 并发连接管理 (ConcurrentDictionary)
- 后台服务 (BackgroundService)
- 依赖注入 (DI)
- JSON序列化
- CORS支持

### 前端技术
- 原生JavaScript EventSource API
- 自动重连机制
- 指数退避算法
- 实时UI更新
- 响应式设计
- CSS Grid布局
- 动画效果

这个实现确保了SSE连接的稳定性和持久性，通过心跳包机制有效监控连接状态，并在连接断开时自动重连。