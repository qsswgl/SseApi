<!doctype html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSE 接收测试（按用户）</title>
  <style>
    body { font-family: system-ui, Arial; margin: 20px; }
    .row { margin-bottom: 8px; }
    .log { height: 300px; overflow: auto; background: #111; color: #0f0; padding: 8px; white-space: pre-wrap; }
    .badge { padding: 2px 6px; border-radius: 4px; background: #eee; }
    .ok { color: #090; }
    .err { color: #b00; }
  </style>
</head>
<body>
  <h2>SSE 接收测试（按用户）</h2>
  <div class="row">当前 UsersID: <span id="uid" class="badge"></span></div>
  <div class="row">
  <label>修改 UsersID：</label>
  <input id="userIdInput" placeholder="输入新的 UsersID，例如：1" />
  </div>
  <div class="row">
    <button id="btnConnect">连接</button>
    <button id="btnDisconnect" disabled>断开</button>
    <button id="btnReconnect">按输入重连</button>
    <span id="status" class="badge">未连接</span>
  </div>
  <div class="row">事件日志：</div>
  <div id="log" class="log"></div>

  <script>
    const logEl = document.getElementById('log');
    const statusEl = document.getElementById('status');
  const uidEl = document.getElementById('uid');
  const userIdInput = document.getElementById('userIdInput');
    const btnConnect = document.getElementById('btnConnect');
    const btnDisconnect = document.getElementById('btnDisconnect');

    // 从路径 /UsersID/{id} 或查询串 ?UsersID= 获取
    function getUserId() {
      const path = location.pathname;
      // 兼容 /UsersID/1 或 /usersid/1
      const m = path.match(/\/(UsersID|usersid)\/(.+)$/);
      if (m) return decodeURIComponent(m[2]);
      const p = new URLSearchParams(location.search).get('UsersID');
      if (p) return p;
      return '1';
    }

  let userId = getUserId();
  uidEl.textContent = userId;
  userIdInput.value = userId;

    let es = null;

    function log(line, cls) {
      const d = document.createElement('div');
      if (cls) d.className = cls;
      d.textContent = `[${new Date().toLocaleTimeString()}] ${line}`;
      logEl.appendChild(d);
      logEl.scrollTop = logEl.scrollHeight;
    }

    function connect() {
  const url = `/sse/UsersID/${encodeURIComponent(userId)}`;
      es = new EventSource(url);
      es.onopen = () => {
        statusEl.textContent = '已连接';
        statusEl.classList.add('ok');
        btnConnect.disabled = true;
        btnDisconnect.disabled = false;
        log('连接打开');
      };
      es.onmessage = (e) => {
        log(`message: ${e.data}`);
      };
      es.addEventListener('heartbeat', (e) => log(`heartbeat: ${e.data}`));
      es.addEventListener('init', (e) => log(`init: ${e.data}`));
      es.onerror = (e) => {
        statusEl.textContent = '错误/断开';
        statusEl.classList.remove('ok');
        log('连接错误或已断开', 'err');
      };
    }

    function disconnect() {
      if (es) {
        es.close();
        es = null;
      }
      statusEl.textContent = '未连接';
      statusEl.classList.remove('ok');
      btnConnect.disabled = false;
      btnDisconnect.disabled = true;
      log('连接关闭');
    }

    btnConnect.addEventListener('click', connect);
    btnDisconnect.addEventListener('click', disconnect);
    document.getElementById('btnReconnect').addEventListener('click', () => {
      const newId = userIdInput.value.trim();
      if (!newId) { log('请输入有效的 UserId', 'err'); return; }
      if (newId === userId && es) { log('UserId 未变化，已连接'); return; }
      disconnect();
      userId = newId;
      uidEl.textContent = userId;
  // 同步 URL 的 UsersID 参数，保持可刷新/分享
      const url = new URL(location.href);
  url.searchParams.set('UsersID', userId);
      history.replaceState(null, '', url.toString());
      connect();
    });

    // 自动连接
    connect();
  </script>
</body>
</html>
